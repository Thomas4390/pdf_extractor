# IDC Statement (Trailing Fees) extraction prompts
document_type: IDC_STATEMENT

# Mode RAW - copie exacte sans interprétation
system_prompt: |
  Expert extracteur de données PDF de frais de suivi IDC.

  RÈGLES:
  - COMMENCE à partir de la page "Détails des frais de suivi"
  - Colonne "Nom du client" = données complexes encodées → COPIE EXACTE dans raw_client_data
  - Montants = format canadien (ex: "123,45 $")
  - Dates colonne "Date" = YYYY-MM-DD

  IMPORTANT: raw_client_data doit être une COPIE VERBATIM, ne pas interpréter.

  Retourne un JSON valide.

user_prompt: |
  Extrais TOUTES les données de ce rapport de frais de suivi IDC.

  COMMENCE à "Détails des frais de suivi" jusqu'à la FIN du PDF.

  ## MÉTADONNÉES
  - date_rapport: Date génération (si visible)
  - advisor_section: En-tête conseiller (ex: "Achraf El Hajji - 3449L3138")

  ## TRAILING_FEES (tableau)

  Pour CHAQUE ligne:
  | Champ | Description |
  |-------|-------------|
  | raw_client_data | COPIE EXACTE colonne "Nom du client" (avec retours ligne, caractères spéciaux) |
  | account_number | Numéro compte colonne "Numéro de compte" |
  | company | Compagnie colonne "Compagnie" |
  | product | Produit colonne "Produit" |
  | date | Date colonne "Date" (YYYY-MM-DD) |
  | gross_trailing_fee | Frais brut avec $ |
  | net_trailing_fee | Frais net avec $ |

  ## RÈGLES CRITIQUES
  - Extrais TOUTES les lignes sur TOUTES les pages
  - raw_client_data = COPIE EXACTE (ne pas parser)
  - INTERDIT: "// ...", "// continue", troncature

  ## JSON OUTPUT
  ```json
  {
    "document_type": "IDC_STATEMENT",
    "date_rapport": "YYYY-MM-DD",
    "advisor_section": "Nom - CODE",
    "trailing_fees": [
      {
        "raw_client_data": "Â UV 7782 2025-11-17\nboni 75% #111011722 crt\nBourassa A clt Jeanny\nBreault-Therrien",
        "account_number": "1234567",
        "company": "UV",
        "product": "RRSP",
        "date": "2025-10-15",
        "gross_trailing_fee": "123,45 $",
        "net_trailing_fee": "98,76 $"
      }
    ]
  }
  ```

# Mode DIRECT - parsing structuré
system_prompt_direct: |
  Expert extracteur de données PDF de frais de suivi IDC avec parsing structuré.

  RÈGLES:
  - COMMENCE à partir de la page "Détails des frais de suivi"
  - Parse la colonne "Nom du client" en champs structurés
  - Montants = format canadien (ex: "123,45 $")
  - Dates = YYYY-MM-DD

  RÈGLE FONDAMENTALE - CONSEILLER vs CLIENT:
  - CONSEILLER = TOUJOURS après "crt" ou "_crt"
  - CLIENT = nom qui N'EST PAS après "crt"

  ADVISOR_NAME - COPIE VERBATIM:
  - NE JAMAIS convertir initiale → prénom ("T" reste "T", PAS "Thomas")
  - NE JAMAIS reformater ("Lussier,T" → "Lussier,T", PAS "Thomas Lussier")

  CLIENT_NAME - MAJUSCULES:
  - Toujours convertir en MAJUSCULES

  Retourne un JSON valide.

user_prompt_direct: |
  Extrais et PARSE TOUTES les données de ce rapport de frais de suivi IDC.

  COMMENCE à "Détails des frais de suivi" jusqu'à la FIN du PDF.

  ## MÉTADONNÉES
  - date_rapport: Date génération (si visible)
  - advisor_section: En-tête conseiller (ex: "Achraf El Hajji - 3449L3138")

  ## TRAILING_FEES (tableau) - AVEC PARSING

  Pour CHAQUE ligne, extrais ET parse:

  ### Colonnes directes:
  | Champ | Description |
  |-------|-------------|
  | raw_client_data | COPIE EXACTE colonne "Nom du client" |
  | account_number | Numéro compte |
  | company | Compagnie (colonne) |
  | product | Produit |
  | date | Date (YYYY-MM-DD) |
  | gross_trailing_fee | Frais brut avec $ |
  | net_trailing_fee | Frais net avec $ |

  ### Champs parsés depuis raw_client_data:
  | Champ | Règle de parsing |
  |-------|------------------|
  | company_code | Compagnie après "Â " (UV, Assomption, IA, Beneva, RBC, ManuVie...) |
  | company_number | 4-6 chiffres après company_code |
  | policy_date | Date YYYY-MM-DD (après company_number OU dans "_YYYY-MM-DD-EZ") |
  | commission_rate | % après "boni", "_", "recu p" ou "recup" (75% → 75.0) |
  | policy_number | 6-10 chiffres après # OU avant "-NomClient" |
  | advisor_name | APRÈS "crt" - COPIE VERBATIM! ("Lussier,T" → "Lussier,T") |
  | client_first_name | Prénom client EN MAJUSCULES |
  | client_last_name | Nom client EN MAJUSCULES |

  ## RÈGLE CONSEILLER vs CLIENT

  ```
  CONSEILLER = toujours APRÈS "crt" ou "_crt"
  CLIENT = nom qui N'EST PAS après "crt" (peut être SANS "clt"!)
  ```

  ## EXEMPLES DE PARSING

  **Exemple 1 - Nom seul (pas de métadonnées):**
  ```
  Raw: "Jean Dupont"
  → Tous champs parsés = null SAUF:
  → client_first_name: "JEAN", client_last_name: "DUPONT"
  ```

  **Exemple 2 - Format avec "clt":**
  ```
  Raw: "Â UV 7782 2025-11-17\nboni 75% #111011722 crt\nBourassa A clt Jeanny\nBreault-Therrien"
  → company_code: "UV", company_number: "7782", policy_date: "2025-11-17"
  → commission_rate: 75.0, policy_number: "111011722"
  → advisor_name: "Bourassa A" (VERBATIM après crt!)
  → client_first_name: "JEANNY", client_last_name: "BREAULT-THERRIEN"
  ```

  **Exemple 3 - Format SANS "clt":**
  ```
  Raw: "Â Assomption_8055_75%\n#1014289-Mifoubdou_crt\nBourassa_2025-12-01-EZ"
  → company_code: "Assomption", company_number: "8055"
  → commission_rate: 75.0, policy_number: "1014289"
  → client_last_name: "MIFOUBDOU" (entre policy et _crt)
  → advisor_name: "Bourassa" (VERBATIM après _crt!)
  → policy_date: "2025-12-01"
  ```

  **Exemple 4 - Conseiller "Nom,Initiale":**
  ```
  Raw: "Â UV_7782_75%\n#1015126-Emissa_crt\nLussier,T_2025-12-01-EZ"
  → policy_number: "1015126"
  → client_last_name: "EMISSA"
  → advisor_name: "Lussier,T" (VERBATIM! PAS "Thomas"!)
  → policy_date: "2025-12-01"
  ```

  ## RÈGLES CRITIQUES
  - Extrais TOUTES les lignes sur TOUTES les pages
  - advisor_name = COPIE VERBATIM (jamais interpréter initiales!)
  - client = TOUJOURS EN MAJUSCULES
  - Si champ non trouvable → null
  - Si raw_client_data = nom seul → tous champs parsés = null sauf client
  - INTERDIT: "// ...", troncature, interprétation des initiales

  ## JSON OUTPUT
  ```json
  {
    "document_type": "IDC_STATEMENT",
    "date_rapport": "YYYY-MM-DD",
    "advisor_section": "Nom - CODE",
    "trailing_fees": [
      {
        "raw_client_data": "Â UV_7782_75%\n#1015126-Emissa_crt\nLussier,T_2025-12-01-EZ",
        "company_code": "UV",
        "company_number": "7782",
        "policy_date": "2025-12-01",
        "commission_rate": 75.0,
        "policy_number": "1015126",
        "advisor_name": "Lussier,T",
        "client_first_name": null,
        "client_last_name": "EMISSA",
        "account_number": "1234567",
        "company": "UV",
        "product": "WS Assurance (VIRT)",
        "date": "2025-12-09",
        "gross_trailing_fee": "543,77 $",
        "net_trailing_fee": "543,77 $"
      }
    ]
  }
  ```
